pid /var/run/nginx.pid;

events {
    worker_connections 768;
}

http {
    sendfile                on;
    charset                 utf-8;
    tcp_nopush              on;
    tcp_nodelay             on;
    keepalive_timeout       65;
    types_hash_max_size     2048;

    log_format main '[$time_local] $status remote_addr=$remote_addr '
                    'rt=$request_time uct=$upstream_connect_time uht=$upstream_header_time urt=$upstream_response_time '
                    '$http_referer $request $body_bytes_sent $http_user_agent';

    server {
        listen                  80;

        server_name             ${your.domain.com}; 

        charset                 utf-8;
        autoindex_localtime     on;
        server_tokens           off;
        autoindex               off;
        access_log              /var/log/nginx/access-file.log main;

        location / {
            return 301 https://$host$request_uri;
        }

        location ~ /.well-known/acme-challenge {
            allow               all;
            root                /var/www/certbot;
        }
    }

    server {
        listen                  443 ssl;

        server_name             ${your.domain.com};

        ssl_certificate         /etc/nginx/ssl/live/${your.domain.com}/fullchain.pem;
        ssl_certificate_key     /etc/nginx/ssl/live/${your.domain.com}/privkey.pem;

        charset                 utf-8;
        autoindex_localtime     on;
        server_tokens           off;
        autoindex               off;
        access_log              /var/log/nginx/access-file.log main;

        location / {
            proxy_pass          http://wiki:3000;
        }

        location /kroki {
            expires 2M;
            add_header Cache-Control "public";

            rewrite /kroki/(.*) /$1 break;
            proxy_pass          http://kroki:8000;
            proxy_redirect      off;
            proxy_set_header    Host $host;
        }
    }
}